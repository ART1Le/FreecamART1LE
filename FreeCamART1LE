-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Module Kontrol
local PlayerModule = require(localPlayer:WaitForChild("PlayerScripts"):WaitForChild("PlayerModule"))
local Controls = PlayerModule:GetControls()

-- THEME SETTINGS
local Theme = {
    Colors = {
        Background = Color3.fromRGB(28, 32, 40),
        Surface = Color3.fromRGB(36, 40, 50),
        Border = Color3.fromRGB(70, 78, 98),
        Text = Color3.fromRGB(245, 250, 255),
        Accent = Color3.fromRGB(0, 170, 255),
        ToggleOn = Color3.fromRGB(0, 180, 255),
        Button = Color3.fromRGB(44, 48, 60),
        Input = Color3.fromRGB(20, 24, 30),
    },
    Fonts = {
        Title = Enum.Font.GothamBlack,
        Body = Enum.Font.GothamMedium,
    },
    Radius = 12,
}

-- VARIABLES
local freecamEnabled = false
local followEnabled = false
local targetPlayer = nil
local cameraSpeed = 1.0
local sensitivity = 1.5
local pan = Vector2.new(0, 0)
local hiddenGuis = {}
local defaultFOV = 70

-- UI HELPERS
local function createRound(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or Theme.Radius)
    c.Parent = parent
end

local function createStroke(parent, color, thickness)
    local s = Instance.new("UIStroke")
    s.Thickness = thickness or 1
    s.Color = color or Theme.Colors.Border
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = parent
end

-- GUI SETUP
local ScreenGui = Instance.new("ScreenGui", localPlayer:WaitForChild("PlayerGui"))
ScreenGui.Name = "CinematicFreecam_Art1le"
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true 

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.new(0, 260, 0, 280)
MainFrame.Position = UDim2.new(0.5, -130, 0.5, -140)
MainFrame.BackgroundColor3 = Theme.Colors.Background
createRound(MainFrame)
createStroke(MainFrame)

local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Text = "FREECAM ART1LE"
Title.Font = Theme.Fonts.Title
Title.TextColor3 = Theme.Colors.Text
Title.TextSize = 16
Title.BackgroundTransparency = 1

local ToggleBtn = Instance.new("TextButton", MainFrame)
ToggleBtn.Size = UDim2.new(0.85, 0, 0, 40)
ToggleBtn.Position = UDim2.new(0.075, 0, 0.15, 0)
ToggleBtn.Text = "Freecam: OFF"
ToggleBtn.Font = Theme.Fonts.Body
ToggleBtn.TextColor3 = Theme.Colors.Text
ToggleBtn.BackgroundColor3 = Theme.Colors.Button
ToggleBtn.TextSize = 16
createRound(ToggleBtn)
createStroke(ToggleBtn)

local NameInput = Instance.new("TextBox", MainFrame)
NameInput.Size = UDim2.new(0.85, 0, 0, 35)
NameInput.Position = UDim2.new(0.075, 0, 0.35, 0)
NameInput.PlaceholderText = "Target Display Name..."
NameInput.Text = ""
NameInput.Font = Theme.Fonts.Body
NameInput.TextColor3 = Theme.Colors.Text
NameInput.BackgroundColor3 = Theme.Colors.Input
NameInput.TextSize = 14
createRound(NameInput)
createStroke(NameInput)

local FollowBtn = Instance.new("TextButton", MainFrame)
FollowBtn.Size = UDim2.new(0.85, 0, 0, 35)
FollowBtn.Position = UDim2.new(0.075, 0, 0.5, 0)
FollowBtn.Text = "Follow Target: OFF"
FollowBtn.Font = Theme.Fonts.Body
FollowBtn.TextColor3 = Theme.Colors.Text
FollowBtn.BackgroundColor3 = Theme.Colors.Button
FollowBtn.TextSize = 14
createRound(FollowBtn)
createStroke(FollowBtn)

local SpeedLabel = Instance.new("TextLabel", MainFrame)
SpeedLabel.Size = UDim2.new(1, 0, 0, 25)
SpeedLabel.Position = UDim2.new(0, 0, 0.65, 0)
SpeedLabel.Text = "Speed: " .. string.format("%.1f", cameraSpeed) .. " | Zoom: " .. math.floor(camera.FieldOfView)
SpeedLabel.Font = Theme.Fonts.Body
SpeedLabel.TextColor3 = Theme.Colors.Text
SpeedLabel.TextSize = 13
SpeedLabel.BackgroundTransparency = 1

local HintLabel = Instance.new("TextLabel", MainFrame)
HintLabel.Size = UDim2.new(1, 0, 0, 50)
HintLabel.Position = UDim2.new(0, 0, 0.78, 0)
HintLabel.Text = "N: Hide UI | Arrows: Speed\nScroll: Zoom In/Out | L: Photo\nFREECAM BY ART1LE"
HintLabel.Font = Theme.Fonts.Body
HintLabel.TextColor3 = Theme.Colors.Accent
HintLabel.TextSize = 11
HintLabel.BackgroundTransparency = 1

-- DRAGGABLE
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true dragStart = input.Position startPos = MainFrame.Position
    end
end)
UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
end)

-- LOGIC UTILS
local function findTargetByDisplayName(name)
    if name == "" then return nil end
    for _, p in ipairs(Players:GetPlayers()) do
        if string.find(string.lower(p.DisplayName), string.lower(name)) then return p end
    end
    return nil
end

local function setOtherUIVisible(visible)
    pcall(function() StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, visible) end)
    if not visible then
        for _, gui in ipairs(localPlayer.PlayerGui:GetChildren()) do
            if gui:IsA("ScreenGui") and gui ~= ScreenGui and gui.Enabled then
                table.insert(hiddenGuis, gui) gui.Enabled = false
            end
        end
    else
        for _, gui in ipairs(hiddenGuis) do
            if gui and gui.Parent then gui.Enabled = true end
        end
        hiddenGuis = {}
    end
end

local function updateSpeedLabel()
    SpeedLabel.Text = "Speed: " .. string.format("%.1f", cameraSpeed) .. " | Zoom: " .. math.floor(camera.FieldOfView)
end

-- CAMERA RENDER LOOP
RunService.RenderStepped:Connect(function(dt)
    if not freecamEnabled then return end
    
    local moveVector = Vector3.new(0, 0, 0)
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector = moveVector + camera.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector = moveVector - camera.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector = moveVector - camera.CFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector = moveVector + camera.CFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.E) then moveVector = moveVector + Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.Q) then moveVector = moveVector - Vector3.new(0, 1, 0) end
    
    local multiplier = UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and 4 or 1
    local finalSpeed = (cameraSpeed * 50) * multiplier
    
    if followEnabled and targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local targetHrp = targetPlayer.Character.HumanoidRootPart
        local currentPos = camera.CFrame.Position
        local nextPos = currentPos + (moveVector * finalSpeed * dt)
        camera.CFrame = CFrame.lookAt(nextPos, targetHrp.Position)
    else
        camera.CFrame = camera.CFrame + (moveVector * finalSpeed * dt)
        
        if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCurrentPosition
            local delta = UserInputService:GetMouseDelta()
            pan = pan - (delta * sensitivity * 0.1)
            camera.CFrame = CFrame.new(camera.CFrame.Position) * CFrame.fromOrientation(math.rad(pan.Y), math.rad(pan.X), 0)
        else
            UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        end
    end
end)

-- BUTTON ACTIONS
ToggleBtn.MouseButton1Click:Connect(function()
    freecamEnabled = not freecamEnabled
    ToggleBtn.Text = freecamEnabled and "Freecam: ON" or "Freecam: OFF"
    ToggleBtn.BackgroundColor3 = freecamEnabled and Theme.Colors.ToggleOn or Theme.Colors.Button
    
    if freecamEnabled then
        camera.CameraType = Enum.CameraType.Scriptable
        pan = Vector2.new(camera.CFrame:ToOrientation())
        Controls:Disable() 
        setOtherUIVisible(false) 
    else
        camera.CameraType = Enum.CameraType.Custom
        camera.FieldOfView = defaultFOV -- Reset Zoom
        followEnabled = false
        FollowBtn.Text = "Follow Target: OFF"
        FollowBtn.BackgroundColor3 = Theme.Colors.Button
        Controls:Enable() 
        setOtherUIVisible(true) 
        updateSpeedLabel()
    end
end)

FollowBtn.MouseButton1Click:Connect(function()
    if not freecamEnabled then return end
    targetPlayer = findTargetByDisplayName(NameInput.Text)
    
    if targetPlayer then
        followEnabled = not followEnabled
        FollowBtn.Text = followEnabled and "Lock: " .. targetPlayer.DisplayName or "Follow Target: OFF"
        FollowBtn.BackgroundColor3 = followEnabled and Theme.Colors.ToggleOn or Theme.Colors.Button
    else
        FollowBtn.Text = "NOT FOUND"
        task.wait(1)
        FollowBtn.Text = "Follow Target: OFF"
    end
end)

-- NEW INPUT LOGIC (SPEED & ZOOM)
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    
    -- Toggle Menu
    if input.KeyCode == Enum.KeyCode.N then
        ScreenGui.Enabled = not ScreenGui.Enabled
    end

    -- Speed Control via Arrows
    if input.KeyCode == Enum.KeyCode.Up then
        cameraSpeed = math.clamp(cameraSpeed + 0.1, 0.1, 20)
        updateSpeedLabel()
    elseif input.KeyCode == Enum.KeyCode.Down then
        cameraSpeed = math.clamp(cameraSpeed - 0.1, 0.1, 20)
        updateSpeedLabel()
    end
end)

UserInputService.InputChanged:Connect(function(input)
    -- Jika Freecam mati, jangan jalankan logika zoom custom
    if not freecamEnabled then return end
    
    -- Zoom Control via Mouse Wheel (Hanya jalan saat Freecam ON)
    if input.UserInputType == Enum.UserInputType.MouseWheel then
        -- Scroll up = Zoom In (Decrease FOV), Scroll down = Zoom Out (Increase FOV)
        local zoomDelta = input.Position.Z * 2
        camera.FieldOfView = math.clamp(camera.FieldOfView - zoomDelta, 5, 120)
        updateSpeedLabel()
    end
end)
